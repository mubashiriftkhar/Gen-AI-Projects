<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Legal Tech Advisor Assistant</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap (minimal use; Tailwind is primary) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- DOMPurify for safe innerHTML rendering -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <!-- highlight.js for code blocks inside responses -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    /* SuperCSS: small set of extra utilities (requested) */
    .super-scrollbar::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .super-scrollbar::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 8px;
    }

    .super-scrollbar::-webkit-scrollbar-track {
      background: #0f0f0f;
    }

    /* Black & White (Court Theme) */
    :root {
      color-scheme: dark;
    }

    html,
    body {
      background: #0b0b0b;
      color: #eaeaea;
    }

    a {
      color: #ffffff;
      text-decoration: underline;
    }

    /* Chat bubbles */
    .bubble {
      max-width: 100%;
      border-radius: 1.25rem;
      padding: 0.875rem 1rem;
      line-height: 1.6;
    }

    .bubble-user {
      background: #ffffff;
      color: #0b0b0b;
    }

    .bubble-bot {
      background: #111111;
      border: 1px solid #2a2a2a;
    }

    /* Inner HTML (answer) typography */
    .answer * {
      color: inherit !important;
      font-family: system-ui, sans-serif;
    }

    .answer p {
      margin: 0.6rem 0;
      line-height: 1.6;
    }

    .answer b,
    .answer strong {
      font-weight: bold;
      color: #fff;
    }

    .answer i,
    .answer em {
      font-style: italic;
    }

    .answer u {
      text-decoration: underline;
    }

    .answer h1,
    .answer h2,
    .answer h3,
    .answer h4,
    .answer h5,
    .answer h6 {
      color: #fff !important;
      font-weight: 700;
      margin: 0.8rem 0 0.4rem;
    }

    .answer h1 {
      font-size: 1.8rem;
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 0.3rem;
    }

    .answer h2 {
      font-size: 1.5rem;
    }

    .answer h3 {
      font-size: 1.3rem;
    }

    .answer h4 {
      font-size: 1.1rem;
    }

    .answer h5 {
      font-size: 1rem;
    }

    .answer h6 {
      font-size: 0.9rem;
      text-transform: uppercase;
      color: #ccc !important;
    }

    .answer ul {
      list-style-type: disc;
      margin: 0.6rem 0 0.6rem 1.4rem;
    }

    .answer ol {
      list-style-type: decimal;
      margin: 0.6rem 0 0.6rem 1.4rem;
    }

    .answer li {
      margin: 0.3rem 0;
    }

    .answer code,
    .answer pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .answer pre {
      background: #0d0d0d;
      border: 1px solid #2a2a2a;
      border-radius: 1rem;
      padding: 0.75rem;
      overflow: auto;
    }

    .answer code {
      background: #111;
      border: 1px solid #333;
      border-radius: 0.5rem;
      padding: 0.1rem 0.35rem;
    }

    .answer table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.6rem 0;
    }

    .answer th,
    .answer td {
      border: 1px solid #2a2a2a;
      padding: 0.5rem;
      text-align: left;
    }

    .answer th {
      background: #151515;
      font-weight: bold;
    }

    .answer blockquote {
      border-left: 4px solid #2a2a2a;
      margin: 0.6rem 0;
      padding-left: 0.75rem;
      color: #cfcfcf;
      font-style: italic;
    }

    .answer hr {
      border: 0;
      border-top: 1px solid #2a2a2a;
      margin: 0.75rem 0;
    }

    /* Inputs */
    .input-area {
      background: #0f0f0f;
      border-top: 1px solid #1d1d1d;
    }

    .input {
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      color: #fff;
    }

    .input:focus {
      outline: none;
      border-color: #fff;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    /* Buttons */
    .btn-ghost {
      border: 1px solid #2a2a2a;
      background: #0f0f0f;
      color: #fff;
    }

    .btn-ghost:hover {
      background: #151515;
    }

    .btn-primary-bw {
      background: #fff;
      color: #000;
    }

    .btn-primary-bw:hover {
      background: #e5e5e5;
    }

    /* Header */
    .brand-mark {
      letter-spacing: 0.08em;
    }

    /* Message list padding on mobile */
    @media (max-width: 640px) {
      .messages-pad {
        padding-bottom: 7.5rem;
      }
    }

    /* Typing dots */
    .typing {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.5rem;
    }

    .typing span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #fff;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {

      0%,
      80%,
      100% {
        opacity: 0;
      }

      40% {
        opacity: 1;
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="w-full border-b border-neutral-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-white text-black flex items-center justify-center font-black">⚖️</div>
        <div>
          <div class="brand-mark font-extrabold text-lg">Legal Tech Advisor</div>
          <div class="text-xs text-neutral-400">Black & White • Court Theme</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="newChatBtn" class="btn-ghost rounded-2xl px-3 py-2 text-sm">New Chat</button>
        <button id="exportBtn" class="btn-ghost rounded-2xl px-3 py-2 text-sm">Export</button>
        <button id="themeBtn" class="btn-ghost rounded-2xl px-3 py-2 text-sm"
          title="Theme is locked to B/W">B/W</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-3 sm:px-4">
      <!-- Tips banner -->
      <div class="mt-4 mb-3 rounded-2xl border border-neutral-800 p-3 sm:p-4 text-sm text-neutral-300">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-semibold">Welcome</div>
            <div class="text-neutral-400">Ask any legal question. Responses render rich inner HTML with safe
              sanitization.</div>
          </div>
          <button id="clearBtn" class="hidden sm:inline-flex btn-ghost rounded-2xl px-3 py-2 text-sm">Clear</button>
        </div>
      </div>

      <!-- Messages -->
      <div id="messages" class="messages-pad super-scrollbar flex flex-col gap-3 sm:gap-4 py-2 overflow-y-auto"
        style="max-height: calc(100vh - 230px);"></div>
    </div>
  </main>

  <!-- Composer -->
  <div class="input-area w-full sticky bottom-0 left-0">
    <div class="max-w-4xl mx-auto px-3 sm:px-4 py-3">
      <div class="rounded-2xl border border-neutral-800 p-2 sm:p-3 bg-[#0f0f0f]">
        <div class="flex items-end gap-2">
          <textarea id="prompt" rows="1" placeholder="Type your legal question… (Shift+Enter = newline)"
            class="input flex-1 rounded-2xl p-3 resize-none" spellcheck="true"></textarea>
          <div class="flex items-center gap-2">
            <button id="stopBtn" class="btn-ghost rounded-2xl px-3 py-2 text-sm hidden">Stop</button>
            <button id="sendBtn" class="btn-primary-bw rounded-2xl px-4 py-2 font-semibold">Send</button>
          </div>
        </div>
        <div class="flex items-center justify-between mt-2 text-xs text-neutral-500 px-1">
          <div>FastAPI connected • Streams token‑by‑token when available</div>
          <div>Press Enter to send</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="userMsgTpl">
    <div class="w-full flex justify-end">
      <div class="bubble bubble-user shadow-sm">
        <div class="whitespace-pre-wrap"></div>
      </div>
    </div>
  </template>

  <template id="botMsgTpl">
    <div class="w-full flex justify-start">
      <div class="bubble bubble-bot w-full">
        <div class="flex items-center gap-2 mb-2">
          <div class="w-7 h-7 rounded-xl bg-white text-black flex items-center justify-center">⚖️</div>
          <div class="text-sm text-neutral-400">LegalAI</div>
          <button class="ml-auto btn-ghost rounded-xl px-2 py-1 text-xs copyBtn">Copy</button>
        </div>
        <div class="answer prose prose-invert max-w-none"></div>
      </div>
    </div>
  </template>

  <!-- App Script -->
  <script>


    // ---------- CONFIG ----------
    const BACKEND_URL = "http://localhost:8000/research"; // FastAPI endpoint
    // Expected FastAPI responses:
    // 1) JSON: { html: "<h2>...</h2> ..." }
    // 2) Streaming SSE/text: lines such as `data: {"html_chunk":"<p>...</p>"}` and `data: [DONE]`

    // ---------- STATE ----------
    const els = {
      messages: document.getElementById('messages'),
      prompt: document.getElementById('prompt'),
      send: document.getElementById('sendBtn'),
      stop: document.getElementById('stopBtn'),
      clear: document.getElementById('clearBtn'),
      newChat: document.getElementById('newChatBtn'),
      exportBtn: document.getElementById('exportBtn'),
    };

    let controller = null; // AbortController for streaming

    // Resize textarea automatically
    function autosizeTextarea() {
      const ta = els.prompt;
      ta.style.height = 'auto';
      ta.style.height = (ta.scrollHeight) + 'px';
    }
    els.prompt.addEventListener('input', autosizeTextarea);

    // Enter to send, Shift+Enter for newline
    els.prompt.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Buttons
    els.send.addEventListener('click', send);
    if (els.clear) els.clear.addEventListener('click', clearChat);
    els.newChat.addEventListener('click', clearChat);
    els.exportBtn.addEventListener('click', exportChat);

    function clearChat() {
      els.messages.innerHTML = '';
    }

    function exportChat() {
      const time = new Date().toISOString().replace(/[:.]/g, '-');
      const html = `<!doctype html><meta charset="utf-8"><title>LegalAI Export ${time}</title>` + document.getElementById('messages').outerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `legalai-chat-${time}.html`; a.click();
      URL.revokeObjectURL(url);
    }

    function addUserMessage(text) {
      const tpl = document.getElementById('userMsgTpl');
      const node = tpl.content.cloneNode(true);
      node.querySelector('div.whitespace-pre-wrap').textContent = text;
      els.messages.appendChild(node);
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function addBotMessageContainer() {
      const tpl = document.getElementById('botMsgTpl');
      const node = tpl.content.cloneNode(true);
      const msgEl = node.querySelector('.answer');
      const wrapper = node.firstElementChild;
      const copyBtn = node.querySelector('.copyBtn');
      copyBtn.addEventListener('click', () => copyAnswer(msgEl));
      els.messages.appendChild(node);
      els.messages.scrollTop = els.messages.scrollHeight;
      return msgEl;
    }

    function copyAnswer(el) {
      const temp = document.createElement('div');
      temp.innerHTML = el.innerHTML;
      const text = temp.innerText;
      navigator.clipboard.writeText(text).then(() => {
        // Optional: toast
      });
    }

    function toggleStreamingUI(streaming) {
      els.send.disabled = streaming;
      els.stop.classList.toggle('hidden', !streaming);
    }

    async function send() {
      // Show typing dots

      const text = els.prompt.value.trim();
      if (!text || controller) return;

      addUserMessage(text);
      els.prompt.value = '';
      autosizeTextarea();

      const answerEl = addBotMessageContainer();
      const typingIndicator = document.createElement("div");
      typingIndicator.classList.add("typing");
      typingIndicator.innerHTML = `
  <span></span><span></span><span></span>
`;
      answerEl.appendChild(typingIndicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      controller = new AbortController();
      els.stop.onclick = () => controller.abort();
      toggleStreamingUI(true);

      try {
        // Attempt streaming first
        let didStream = await tryStreaming(text, answerEl, controller.signal);
        if (!didStream) {
          // Fallback: non-streaming JSON
          await fetchNonStreaming(text, answerEl, controller.signal);
        }
      } catch (err) {
        if (err.name === 'AbortError') {
          appendSafeHTML(answerEl, '<em>Generation stopped.</em>');
        } else {
          if (typingIndicator && typingIndicator.parentNode) {
            typingIndicator.parentNode.removeChild(typingIndicator);
          }
          console.error(err);
          appendSafeHTML(answerEl, '<em>Sorry, something went wrong.</em>');
        }
      } finally {
        controller = null;
        toggleStreamingUI(false);
        // Re-highlight any code blocks
        answerEl.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      }

    }
    async function tryStreaming(text, answerEl, signal, typingIndicator) {
      try {
        const response = await fetch("/stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: text }),
          signal
        });

        if (!response.body) return false;
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let firstChunk = true;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          if (firstChunk && typingIndicator?.parentNode) {
            typingIndicator.remove(); // ✅ remove dots
            firstChunk = false;
          }
          const chunk = decoder.decode(value, { stream: true });
          appendSafeHTML(answerEl, chunk);
        }
        return true;
      } catch (e) {
        console.error("Streaming failed", e);
        return false;
      }
    }

    async function fetchNonStreaming(userText, answerEl, signal) {
      const resp = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: userText }),
        signal,
      });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const ctype = resp.headers.get('content-type') || '';
      if (ctype.includes('application/json')) {
        const data = await resp.json();
        const html = data.inner_html;
        // console.log(data)
        // console.log(html)


        appendTokenized(answerEl, html);
      } else {
        const html = await resp.text();
        appendTokenized(answerEl, html);
      }
    }

    // Token-by-token rendering (word-level to preserve HTML tags)
    function appendTokenized(target, fullHTML) {
      if (!fullHTML) return;
      // Strategy: split by tags vs text; animate text by words, inject tags instantly.
      const frag = document.createDocumentFragment();
      const container = document.createElement('div');
      container.className = 'tokenizer';
      frag.appendChild(container);
      target.appendChild(frag);

      // Parse into tokens: tags and text
      const tokens = fullHTML.match(/<[^>]+>|[^<]+/g) || [fullHTML];
      let i = 0;
      const tick = () => {
        if (i >= tokens.length) return;
        const t = tokens[i++];
        if (t.startsWith('<')) {
          // Inject tags directly
          container.insertAdjacentHTML('beforeend', DOMPurify.sanitize(t, { ADD_ATTR: ['target'] }));
        } else {
          // Animate text by words
          const words = t.split(/(\s+)/);
          let j = 0;
          const wt = () => {
            if (j >= words.length) { next(); return; }
            container.insertAdjacentHTML('beforeend', DOMPurify.sanitize(words[j++]));
            scrollToBottom();
            setTimeout(wt, 10); // speed here
          };
          wt();
          return; // prevent next() until words done
        }
        next();
      };
      const next = () => { scrollToBottom(); setTimeout(tick, 0); };
      tick();
    }

    function appendSafeHTML(target, html) {
      if (!html) return;
      const clean = DOMPurify.sanitize(html, {
        ADD_TAGS: ['table', 'thead', 'tbody', 'tr', 'th', 'td', 'code', 'pre', 'details', 'summary'],
        ADD_ATTR: ['target', 'rel', 'class', 'id', 'data-*']
      });
      const tmp = document.createElement('div');
      tmp.innerHTML = clean;
      // move children (preserve events for existing)
      while (tmp.firstChild) target.appendChild(tmp.firstChild);
    }

    function scrollToBottom() {
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    // Highlight code inside dynamically added content
    const observe = new MutationObserver((mutations) => {
      for (const m of mutations) {
        m.addedNodes.forEach(node => {
          if (!(node instanceof HTMLElement)) return;
          node.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        })
      }
    });
    observe.observe(document.getElementById('messages'), { childList: true, subtree: true });

    // Warm welcome message (static)
    (function bootstrapWelcome() {
      const el = addBotMessageContainer();
      appendSafeHTML(el, '<p><strong>How can I help you today?</strong> Provide jurisdiction and context for more precise guidance.</p>');
    })();
  </script>

  <!-- Optional Bootstrap JS (not required) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>